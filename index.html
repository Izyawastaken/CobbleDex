<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CobbleDex</title>
  <style>@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

    :root {
      --bg-light: #f9f9fb;
      --bg-dark: #121212;
      --card-light: rgba(255, 255, 255, 0.1);
      --card-dark: rgba(30, 30, 30, 0.3);
      --accent: #e3350d;
      --radius: 18px;
      --shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
      --glow: 0 0 12px var(--accent);
      --transition: 0.35s ease;
      --blur: blur(12px);
    }
    
    /* ========== General Layout ========== */
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%);
      color: #333;
      margin: 0;
      padding: 2rem;
      text-align: center;
      transition: background var(--transition), color var(--transition);
      overflow-x: hidden;
    }
    
    body.dark {
      background: linear-gradient(135deg, #1c1c1c 0%, #121212 100%);
      color: #eee;
    }
    
    h1.title {
      font-size: 3.5rem;
      font-weight: 600;
      color: var(--accent);
      text-shadow: var(--glow);
      margin-bottom: 1.5rem;
      transition: text-shadow var(--transition), color var(--transition);
    }
    
    /* ========== Buttons ========== */
    button {
      padding: 0.65rem 1.3rem;
      border: none;
      border-radius: 50px;
      background: linear-gradient(145deg, var(--accent), var(--accent));
      color: white;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    button:hover {
      transform: scale(1.07);
      box-shadow: 0 0 14px var(--accent);
      background: linear-gradient(145deg, var(--accent), var(--accent));
    }
    
    #toggle-theme {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1.2rem;
      font-weight: 600;
      font-size: 0.95rem;
      background: var(--accent);
      color: white;
      box-shadow: 0 0 10px var(--accent);
    }
    
    /* ========== Input + Search Layout ========== */
    .search-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    
    .input-container {
      position: relative;
      display: inline-block;
      width: 240px;
    }
    
    select,
    input[type="text"] {
      padding: 0.65rem 1rem;
      font-size: 1rem;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: var(--card-light);
      backdrop-filter: var(--blur);
      color: inherit;
      transition: all var(--transition);
      outline: none;
      box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.05);
    }
    
    select:hover,
    input[type="text"]:hover,
    select:focus,
    input[type="text"]:focus {
      box-shadow: 0 0 8px var(--accent);
      border-color: var(--accent);
    }
    
    /* Autofill Fix */
    input[type="text"] {
      border: none;
      box-shadow: none !important;
      background-clip: padding-box;
    }
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      box-shadow: 0 0 0px 1000px var(--card-light) inset !important;
      -webkit-text-fill-color: inherit !important;
      caret-color: inherit;
      transition: background-color 5000s ease-in-out 0s;
    }
    
    /* ========== Autocomplete ========== */
    .autocomplete {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      max-height: 200px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow-y: auto;
      z-index: 1000;
    }
    
    .autocomplete div {
      padding: 0.5rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .autocomplete div:hover {
      background: #f0f0f0;
    }
    
    .autocomplete-item.selected {
      background: #ddd;
    }
    
    body.dark .autocomplete {
      background: #2a2a2a;
      color: white;
    }
    body.dark .autocomplete div:hover {
      background: #3a3a3a;
    }
    body.dark .autocomplete-item.selected {
      background: #444;
    }
    
    /* ========== Misc Layout ========== */
    .pokedex {
      background: var(--card-light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      margin: 1rem auto;
      max-width: 900px;
      backdrop-filter: var(--blur);
      transition: all var(--transition);
    }
    
    body.dark .pokedex {
      background: var(--card-dark);
    }
    
    img {
      width: 160px;
      border-radius: var(--radius);
      margin: 1rem auto;
      transition: transform 0.25s ease-in-out;
    }
    
    img:hover {
      transform: scale(1.08);
      cursor: pointer;
    }
    
    /* ========== Tabs ========== */
    .tab {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .tab button {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      border-radius: var(--radius);
      backdrop-filter: var(--blur);
    }
    
    body.dark .tab button {
      background: rgba(40, 40, 40, 0.3);
      color: white;
    }
    
    .tab-content {
      display: none;
      margin-top: 1rem;
      text-align: left;
      animation: fadeIn 0.5s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ========== Stats Table ========== */
    .stats-table {
      width: 100%;
      table-layout: fixed;
    }
    
    .stats-table th,
    .stats-table td {
      padding: 0.3rem 0.4rem;
      vertical-align: middle;
    }
    
    .stats-table th {
      text-align: left;
      color: var(--accent);
      font-weight: 600;
    }
    
    .stats-table th:nth-child(1),
    .stats-table td:nth-child(1) {
      width: 60px;
    }
    
    .stats-table th:nth-child(3),
    .stats-table td:nth-child(3) {
      width: 40px;
      text-align: right;
      padding-right: 0.3rem;
    }
    
    .stats-bar-container {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      height: 12px;
      overflow: hidden;
    }
    
    .stats-bar {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      border-radius: 6px;
      padding-right: 6px;
      font-size: 0.85rem;
      font-weight: bold;
      color: white;
    }
    
    /* Stat Colors */
    .stats-bar.terrible    { background: #f44336; }
    .stats-bar.very-low    { background: #ff7043; }
    .stats-bar.low         { background: #f5dc40; }
    .stats-bar.mid         { background: #8bc34a; }
    .stats-bar.high        { background: #4caf50; }
    .stats-bar.very-high   { background: #4fc3f7; }
    .stats-bar.ultra       { background: #00bcd4; }
    
    /* ========== Types & Abilities ========== */
    .types span {
      margin: 0 5px;
      padding: 6px 10px;
      border-radius: 20px;
      font-weight: bold;
      display: inline-block;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .types.type-fire     { background: #F08030; color: white; }
    .types.type-water    { background: #6890F0; color: white; }
    .types.type-grass    { background: #78C850; color: white; }
    .types.type-electric { background: #F8D030; color: black; }
    .types.type-ice      { background: #98D8D8; color: black; }
    .types.type-fighting { background: #C03028; color: white; }
    .types.type-poison   { background: #A040A0; color: white; }
    .types.type-ground   { background: #E0C068; color: black; }
    .types.type-flying   { background: #A890F0; color: white; }
    .types.type-psychic  { background: #F85888; color: white; }
    .types.type-bug      { background: #A8B820; color: white; }
    .types.type-rock     { background: #B8A038; color: white; }
    .types.type-ghost    { background: #705898; color: white; }
    .types.type-dragon   { background: #7038F8; color: white; }
    .types.type-dark     { background: #705848; color: white; }
    .types.type-steel    { background: #B8B8D0; color: black; }
    .types.type-fairy    { background: #EE99AC; color: black; }
    .types.type-normal   { background: #A8A878; color: white; }
    
    .ability-pill {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-weight: 600;
      color: white;
      background: var(--accent);
      margin: 4px;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .ability-pill:hover {
      background: #c62828;
      transform: scale(1.05);
    }
    
    .ability-pill.priority {
      background: teal;
    }
    
    .ability-pill.hidden {
      background: #7b1fa2;
    }
    
    /* ========== Footer ========== */
    footer {
      margin-top: 2rem;
      font-size: 0.9rem;
      opacity: 0.7;
    }
    
    footer a {
      color: var(--accent);
      text-decoration: none;
      transition: opacity 0.2s ease;
    }
    
    footer a:hover {
      opacity: 1;
    }
    
    /* ========== Animation ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* ========== Responsive ========== */
    @media (max-width: 600px) {
      h1.title {
        font-size: 2.2rem;
      }
    
      .search-wrapper {
        flex-direction: column;
        gap: 1rem;
      }
    }
    /* —— “Report issues” link —— */
      .report-link {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: var(--accent);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        text-decoration: none;
        font-weight: 600;
        transition: opacity 0.2s ease;
      }
      .report-link:hover {
        opacity: 0.8;
}
.stats-bar {
  width: 0%;
  transition: width 1.2s ease-in-out;
}
@keyframes subtleGlow {
  0%, 100% {
    text-shadow: 0 0 8px var(--accent);
  }
  50% {
    text-shadow: 0 0 16px var(--accent);
  }
}

h1.title {
  animation: subtleGlow 2.5s ease-in-out infinite;
}

body.dark 
.types.type-fire     { box-shadow: 0 0 8px #F08030; }
.types.type-water    { box-shadow: 0 0 8px #6890F0; }
.types.type-grass    { box-shadow: 0 0 8px #78C850; }
.types.type-electric { box-shadow: 0 0 8px #F8D030; }
.types.type-ice      { box-shadow: 0 0 8px #98D8D8; }
.types.type-fighting { box-shadow: 0 0 8px #C03028; }
.types.type-poison   { box-shadow: 0 0 8px #A040A0; }
.types.type-ground   { box-shadow: 0 0 8px #E0C068; }
.types.type-flying   { box-shadow: 0 0 8px #A890F0; }
.types.type-psychic  { box-shadow: 0 0 8px #F85888; }
.types.type-bug      { box-shadow: 0 0 8px #A8B820; }
.types.type-rock     { box-shadow: 0 0 8px #B8A038; }
.types.type-ghost    { box-shadow: 0 0 8px #705898; }
.types.type-dragon   { box-shadow: 0 0 8px #7038F8; }
.types.type-dark     { box-shadow: 0 0 8px #705848; }
.types.type-steel    { box-shadow: 0 0 8px #B8B8D0; }
.types.type-fairy    { box-shadow: 0 0 8px #EE99AC; }
.types.type-normal   { box-shadow: 0 0 8px #A8A878; } 

.optimized-tab-toggle {
position: fixed;
bottom: 3.5rem;
right: 1rem;
padding: 0.5rem 1rem;
font-weight: 600;
font-size: 0.95rem;
background: var(--accent);
color: white;
border: none;
border-radius: var(--radius);
box-shadow: var(--shadow);
cursor: pointer;
transition: opacity 0.2s ease, transform 0.2s ease;
}
.optimized-tab-toggle:hover {
opacity: 0.9;
transform: scale(1.05);
}
.optimized-tab-toggle {
position: fixed;
bottom: 3.5rem;
right: 1rem;
padding: 0.5rem 1rem;
font-weight: 600;
font-size: 0.95rem;
background: var(--accent);
color: white;
border: none;
border-radius: var(--radius);
box-shadow: var(--shadow);
cursor: pointer;
transition: opacity 0.2s ease, transform 0.2s ease;
}
.optimized-tab-toggle:hover {
opacity: 0.9;
transform: scale(1.05);
}

#accentPicker {
  position: fixed;
  top: 1rem;
  left: 1rem;
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 50%;
  box-shadow: var(--shadow);
  cursor: pointer;
  background: none;
  appearance: none;
  -webkit-appearance: none;
  overflow: hidden;
  padding: 0;
}

/* Ensure circular swatch wrapper */
#accentPicker::-webkit-color-swatch-wrapper {
  padding: 0;
  border-radius: 50%;
  overflow: hidden;
}

/* Style the color swatch inside */
#accentPicker::-webkit-color-swatch {
  border: none;
  border-radius: 50%;
  padding: 0;
}
body.dark select {
  background: rgba(40, 40, 40, 0.8); /* darker background */
  color: #eee; /* light text */
  border: 1px solid #444;
}

/* Optional: Add better styling for the options in dark mode */
body.dark select option {
  background: #2a2a2a;
  color: #eee;
}
body.dark select {
  backdrop-filter: blur(6px);
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
}

#easterEgg {
  cursor: pointer;
  transition: transform 0.2s ease;
}
#easterEgg:hover {
  transform: scale(1.3);
}
#toggleCobblemon {
  position: fixed;
  bottom: 6rem;
  right: 1rem;
  padding: 0.5rem 1rem;
  font-weight: 600;
  font-size: 0.95rem;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  cursor: pointer;
  transition: opacity 0.2s ease, transform 0.2s ease;
}
#toggleCobblemon:hover {
  opacity: 0.9;
  transform: scale(1.05);
}


  </style>
</head>
<body>
  
  <h1 class="title">Primordium</h1>
  <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
  <button onclick="goBack()">Go Back</button>
  <button id="toggleCobblemon" onclick="toggleCobblemon()">Cobblemon: OFF</button>

  <div class="search-wrapper">
    <select id="searchType">
      <option value="pokemon">Pokémon</option>
      <option value="item">Item</option>
      <option value="ability">Ability</option>
      <option value="move">Move</option>
    </select>
  
    <div class="input-container">
      <input type="text" id="pokemonInput" placeholder="Enter name or ID" oninput="autocomplete()" />
      <div id="autocomplete-list" class="autocomplete"></div>
    </div>
  
    <button onclick="searchEntity()">Search</button>
  </div>
  

  <div class="pokedex" id="pokedex" style="display:none;">
    <audio id="cryAudio"></audio>
    <h2 id="pokemonName"></h2>
    <img id="pokemonImg" src="" alt="Sprite" onclick="playCry()" title="Click to hear cry">

    <div class="tab">
      <button onclick="showTab('info')">Info</button>
      <button onclick="showTab('moves')">Moves</button>
      <button onclick="showTab('damage')">Type Matchups</button>
      <button onclick="showTab('strategy')">Strategy</button>
      <button onclick="openCalculator()">Calculator</button>
      <button onclick="openShowdown()">Showdown</button>
    </div>

    <!-- Info Tab -->
    <div id="info" class="tab-content active">
      <p><strong>Types:</strong> <span class="types" id="pokemonTypes"></span></p>
      <p><strong>Abilities:</strong> <span id="pokemonAbilities"></span></p>

      <h3>Base Stats:</h3>
      <div id="statsChart"></div>

      <p><strong>Flavor Text:</strong></p>
      <p id="flavorText"></p>
      <p id="cobblemonStatus" style="display: none; font-weight: bold;"></p>

    </div>

    <!-- Moves -->
    <div id="moves" class="tab-content">
      <p><strong>Moves:</strong></p>
      <ul id="pokemonMoves"></ul>
    </div>

    <!-- Evolution -->
    <div id="evolution" class="tab-content">
      <p><strong>Evolution Chain:</strong></p>
      <ul id="evolutionChain"></ul>
    </div>

    <!-- Damage Relations -->
    <div id="damage" class="tab-content">
      <p><strong>Type Damage Relations:</strong></p>
      <ul id="damageRelations"></ul>
    </div>

    <!-- Strategy -->
    <div id="strategy" class="tab-content">
      <p><strong>Strategy Tips:</strong></p>
      <p id="strategyText">Loading…</p>
    </div>
  </div>

  <button id="toggleOptimizedTabs" class="optimized-tab-toggle" onclick="toggleOptimizedTabs()">
    Optimised Tabs: OFF
  </button>
  

  <!-- InfoBox for Moves/Abilities/Items -->
  <div class="pokedex" id="infoBox" style="display:none;">
    <h2 id="infoTitle"></h2>
    <p id="infoDescription"></p>
    <ul id="infoDetails"></ul>
  </div>
  <a
  href="https://github.com/Izyawastaken/CobbleDex/issues"
  target="_blank"
  class="report-link"
>
  Report issues here!
</a>
<input type="color" id="accentPicker" title="Pick your accent color" value="#e3350d" />

<footer>
  <p>
    Made with <span id="easterEgg" title="Click me!">❤️</span> by Izya 
    (and a lot of redbulls, sleepless nights). 
    Data from <a href="https://pokeapi.co/" target="_blank">PokéAPI</a>.
  </p>
</footer>

<script>
  const twitchLinks = [
    "https://www.twitch.tv/astralaeyna",
    "https://www.twitch.tv/jophunny",
    "https://www.twitch.tv/kingroxas0727",
    "https://www.twitch.tv/velvet_theoden",
    "https://www.twitch.tv/baitakey",
    "https://www.twitch.tv/frostedplague7",
    "https://www.twitch.tv/duckduckdduk",
    "https://www.twitch.tv/k1rbypl4yz",
    "https://www.twitch.tv/whimsygaming1314"
  ];

  document.getElementById("easterEgg").addEventListener("click", () => {
    const randomUrl = twitchLinks[Math.floor(Math.random() * twitchLinks.length)];
    window.open(randomUrl, "_blank");
  });

  const cache = localStorage;
  let allData = { pokemon:[], item:[], ability:[], move:[] };
  const historyStack = [];

  // ── track which ability we’ll pass to pkmn.help ──
  let currentAbility = 'none';
  const priorityAbilities = [
    "delta-stream","dry-skin","earth-eater","filter","flash-fire","fluffy",
    "heatproof","levitate","lightning-rod","motor-drive","purifying-salt",
    "sap-sipper","storm-drain","tera-shell","thick-fat","volt-absorb",
    "water-absorb","water-bubble","well-baked-body","wonder-guard"
 ];

  // fetch autocomplete lists
  async function fetchAllNames() {
    for (let t of ['pokemon','item','ability','move']) {
      let key = `names_${t}`, c = cache.getItem(key);
      if (c) allData[t] = JSON.parse(c);
      else {
        let r = await fetch(`https://pokeapi.co/api/v2/${t}?limit=10000`);
        let j = await r.json();
        allData[t] = j.results.map(x=>x.name);
        cache.setItem(key, JSON.stringify(allData[t]));
      }
    }
  }
  
  function toggleDarkMode() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  document.querySelector('button[onclick="toggleDarkMode()"]').textContent =
    isDark ? 'Toggle Light Mode' : 'Toggle Dark Mode';
}

  function playCry() {
    document.getElementById('cryAudio').play();
  }

  function pushHistory(name) {
    let cur = document.getElementById('pokemonName').textContent.toLowerCase();
    if (cur && cur!==name) historyStack.push(cur);
  }
  function goBack() {
    if (!historyStack.length) return;
    let prev = historyStack.pop();
    document.getElementById('pokemonInput').value = prev;
    getPokemon();
  }

  let useOptimizedTabs = false;
let optimizedTabRef = null;

function toggleOptimizedTabs() {
useOptimizedTabs = !useOptimizedTabs;
document.getElementById("toggleOptimizedTabs").textContent =
  `Optimised Tabs: ${useOptimizedTabs ? "ON" : "OFF"}`;
}

function openSmartTab(url) {
if (useOptimizedTabs) {
  if (!optimizedTabRef || optimizedTabRef.closed) {
    optimizedTabRef = window.open(url, "OptimisedTab");
  } else {
    optimizedTabRef.location.href = url;
    optimizedTabRef.focus();
  }
} else {
  window.open(url, "_blank");
}
}

function showTab(id) {
const name = document.getElementById('pokemonName').textContent.toLowerCase();

if (id === 'strategy') {
  return openSmartTab(`https://www.smogon.com/dex/sv/pokemon/${name}/`);
}

if (id === 'damage') {
  const types = Array.from(
    document.getElementById('pokemonTypes').children
  )
    .map(span => span.textContent.toLowerCase())
    .join('+');

  if (types) {
    const url = `https://www.pkmn.help/defense/?types=${types}&ability=${currentAbility}&tera_type=none`;
    return openSmartTab(url);
  }
  return;
}

if (id === 'moves') {
  return openSmartTab(`https://bulbapedia.bulbagarden.net/wiki/${name.charAt(0).toUpperCase() + name.slice(1)}_(Pokémon)#Learnset`);
}

// Normal tab display logic
document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
document.getElementById(id).classList.add('active');
}


  function setupAutocomplete() {
    const inp = document.getElementById('pokemonInput');
    const list= document.getElementById('autocomplete-list');
    let idx=-1, sug=[];
    inp.addEventListener('input', ()=>{
      let v=inp.value.toLowerCase(), t=document.getElementById('searchType').value;
      list.innerHTML=''; sug=[]; idx=-1;
      if (!v) return;
      sug = allData[t].filter(n=>n.includes(v)).slice(0,10);
      sug.forEach((n,i)=>{
        let d=document.createElement('div');
        d.textContent=n; d.className='autocomplete-item'; d.dataset.idx=i;
        d.onclick=()=>{ inp.value=n; list.innerHTML=''; searchEntity(); };
        list.appendChild(d);
      });
    });
    inp.addEventListener('keydown', e=>{
      let items=list.querySelectorAll('.autocomplete-item');
      if (e.key==='ArrowDown') { idx=(idx+1)%items.length; updateSel(items,idx); e.preventDefault(); }
      if (e.key==='ArrowUp')   { idx=(idx-1+items.length)%items.length; updateSel(items,idx); e.preventDefault(); }
      if (e.key==='Enter')     {
        e.preventDefault();
        if (idx>=0 && items[idx]) items[idx].click();
        else searchEntity();
      }
    });
  }
  function updateSel(it,i) {
    it.forEach(x=>x.classList.remove('selected'));
    if (i>=0) it[i].classList.add('selected');
  }

  async function searchEntity() {
    let q=document.getElementById('pokemonInput').value.trim().toLowerCase(),
        t=document.getElementById('searchType').value;
    document.getElementById('pokedex').style.display='none';
    document.getElementById('infoBox').style.display='none';
    if (!q) return;
    if (t==='pokemon') return getPokemon();
    try {
      let r=await fetch(`https://pokeapi.co/api/v2/${t}/${q}`);
      if (!r.ok) return alert(`${t} not found.`);
      let d=await r.json();
      let box=document.getElementById('infoBox');
      box.style.display='block';
      document.getElementById('infoTitle').textContent=d.name.toUpperCase();
      document.getElementById('infoDetails').innerHTML='';
      let desc=document.getElementById('infoDescription');
      if (t==='item') {
        desc.textContent=d.effect_entries.find(e=>e.language.name==='en')?.effect||'No description';
        document.getElementById('infoDetails').innerHTML=`<li><strong>Category:</strong> ${d.category.name}</li>`;
      }
      else if (t==='ability') {
        desc.textContent=d.effect_entries.find(e=>e.language.name==='en')?.short_effect||'No desc';
        document.getElementById('infoDetails').innerHTML=`<li><strong>Generation:</strong> ${d.generation.name}</li>`;
      }
      else if (t==='move') {
        desc.textContent=d.effect_entries.find(e=>e.language.name==='en')?.effect||'No desc';
        document.getElementById('infoDetails').innerHTML=`
          <li><strong>Type:</strong> ${d.type.name}</li>
          <li><strong>Power:</strong> ${d.power||'N/A'}</li>
          <li><strong>PP:</strong> ${d.pp}</li>
          <li><strong>Accuracy:</strong> ${d.accuracy||'N/A'}</li>`;
      }
    }
    catch {
      alert('Error fetching data.');
    }
  }

  async function getPokemon(ov=null) {
    let n=ov||document.getElementById('pokemonInput').value.trim().toLowerCase();
    let r=await fetch(`https://pokeapi.co/api/v2/pokemon/${n}`);
    if(!r.ok) return alert('Pokémon not found.');
    let d=await r.json();
    pushHistory(n);
    document.getElementById('pokedex').style.display='block';
    document.getElementById('pokemonName').textContent = d.name.toUpperCase();
currentPokemonName = d.name; // 👈 This stores the current Pokémon
updateCobblemonStatus(currentPokemonName); // 👈 This updates the Cobblemon status

    document.getElementById('pokemonImg').src=d.sprites.other['official-artwork'].front_default||d.sprites.front_default;
   // ── inside your getPokemon(d) after fetching d ──
const cryAudio = document.getElementById('cryAudio');
const base = d.name.toLowerCase();
// If .ogg fails, try .mp3 once
cryAudio.onerror = function() {
this.onerror = null;
this.src = `https://play.pokemonshowdown.com/audio/cries/${base}.mp3`;
};
// Now kick off the request for .ogg
cryAudio.src = `https://play.pokemonshowdown.com/audio/cries/${base}.ogg`;


document.getElementById('pokemonTypes').innerHTML =
  d.types.map(t => {
    const tn = t.type.name.toLowerCase();
    const label = tn[0].toUpperCase() + tn.slice(1);
    const url = `https://www.pkmn.help/defense/?types=${tn}&ability=none&tera_type=none`;
    return `<a href="#" onclick="openSmartTab('${url}'); return false;">
              <span class="types type-${tn}">${label}</span>
            </a>`;
  }).join('');


    // abilities
          const abilityNames = d.abilities.map(o => o.ability.name);
          // pick a priority ability if present, otherwise the first ability
          let rawAbility = abilityNames.find(a => priorityAbilities.includes(a))
              || abilityNames[0]
              || 'none';
          currentAbility = rawAbility.replace(/-/g, '_');
          // build the pills (linking out to PokemonDB)
          const abilityHTML = d.abilities.map(obj => {
          const ab = obj.ability.name.toLowerCase();
          const display = ab.replace(/-/g,' ')
                          .replace(/\b\w/g, c => c.toUpperCase());
          const isHidden  = obj.is_hidden;
          const isPrio    = priorityAbilities.includes(ab);
          const cls       = isPrio ? 'priority' : (isHidden ? 'hidden' : '');
          return `<a 
  class="ability-pill ${cls}" 
  href="#" 
  onclick="openSmartTab('https://pokemondb.net/ability/${ab}'); return false;"
>
  ${display}${isHidden ? ' (HA)' : ''}
</a>`;
          }).join('');
          document.getElementById('pokemonAbilities').innerHTML = abilityHTML;



    // —— base stats chart —— 
    (() => {
const shorthand = {
  hp: "HP",
  attack: "Atk",
  defense: "Def",
  "special-attack": "SpA",
  "special-defense": "SpD",
  speed: "Spe",
};

let stats = d.stats.map(s => ({
  n: shorthand[s.stat.name] || s.stat.name.toUpperCase(),
  v: s.base_stat
}));

let maxV = Math.max(200, ...stats.map(x => x.v));
let html = `
  <table class="stats-table">
    <thead>
      <tr>
        <th>Stat</th>
        <th>Bar</th>
        <th>Base</th>
      </tr>
    </thead>
    <tbody>`;

stats.forEach((s, i) => {
  let pct = (s.v / maxV * 100).toFixed(1);
  let cls = "terrible";
  if (s.v >= 140) cls = "ultra";
  else if (s.v >= 120) cls = "very-high";
  else if (s.v >= 100) cls = "high";
  else if (s.v >= 80) cls = "mid";
  else if (s.v >= 60) cls = "low";
  else if (s.v >= 40) cls = "very-low";

  html += `
    <tr>
      <td>${s.n}</td>
      <td>
        <div class="stats-bar-container">
          <div class="stats-bar ${cls}" data-width="${pct}%"></div>
        </div>
      </td>
      <td class="stat-value">${s.v}</td>
    </tr>`;
});

let tot = stats.reduce((a, b) => a + b.v, 0);
html += `
    <tr>
      <td><strong>Total</strong></td>
      <td></td>
      <td><strong>${tot}</strong></td>
    </tr>
  </tbody>
</table>`;

const container = document.getElementById("statsChart");
container.innerHTML = html;


// Animate stat bars after rendering
const bars = container.querySelectorAll('.stats-bar');
bars.forEach((bar, i) => {
bar.style.width = '0%';
bar.offsetHeight;
setTimeout(() => {
  bar.style.width = bar.dataset.width;
}, 100 * i); // 100ms stagger per stat
});

    })();



    // moves
    let ml=document.getElementById('pokemonMoves');
    ml.innerHTML='Loading…';
    let mv=await Promise.all(d.moves.slice(0,10).map(async m=>{
      let md=await (await fetch(m.move.url)).json(),
          lvl=m.version_group_details[0]?.level_learned_at||'-';
      return `<li>
        <a href="#" onclick="showMove('${md.name}')">${md.name}</a>
        <span class="move-details">
          (Type:${md.type.name}, Power:${md.power||'N/A'}, Lv:${lvl})
        </span>
      </li>`;
    }));
    ml.innerHTML = mv.join('');

    // flavor text
    let sp=await (await fetch(d.species.url)).json();
    let txt=sp.flavor_text_entries.find(e=>e.language.name==='en')?.flavor_text
              .replace(/\n|\f/g,' ')||'No entry';
    document.getElementById('flavorText').textContent = txt;
    

    // evolution
    let ec=await (await fetch(sp.evolution_chain.url)).json();
    let chain=[], c=ec.chain;
    do { chain.push(c.species.name); c=c.evolves_to[0]; } while(c);
    document.getElementById('evolutionChain').innerHTML =
      chain.map(p=>`<li><a href="#" onclick="getPokemon('${p}')">${p}</a></li>`).join('');

    // damage relations
    let tds=await Promise.all(d.types.map(t=>fetch(t.type.url).then(r=>r.json())));
    let rel=new Set();
    tds.forEach(td=>{
      td.damage_relations.double_damage_from.forEach(x=>rel.add(`2× from ${x.name}`));
      td.damage_relations.half_damage_from.forEach(x=>rel.add(`0.5× from ${x.name}`));
      td.damage_relations.no_damage_from.forEach(x=>rel.add(`Immune to ${x.name}`));
    });
    document.getElementById('damageRelations').innerHTML =
      [...rel].map(r=>`<li>${r}</li>`).join('');
  }

  async function showAbility(n){
    let r=await fetch(`https://pokeapi.co/api/v2/ability/${n}`);
    if(!r.ok) return alert('Ability not found.');
    let d=await r.json();
    document.getElementById('infoBox').style.display='block';
    document.getElementById('infoTitle').textContent=d.name.toUpperCase();
    document.getElementById('infoDescription').textContent=
      d.effect_entries.find(e=>e.language.name==='en')?.short_effect||'No desc';
    document.getElementById('infoDetails').innerHTML=
      `<li><strong>Generation:</strong> ${d.generation.name}</li>`;
  }
  async function showMove(n){
    let r=await fetch(`https://pokeapi.co/api/v2/move/${n}`);
    if(!r.ok) return alert('Move not found.');
    let d=await r.json();
    document.getElementById('infoBox').style.display='block';
    document.getElementById('infoTitle').textContent=d.name.toUpperCase();
    document.getElementById('infoDescription').textContent=
      d.effect_entries.find(e=>e.language.name==='en')?.effect||'No desc';
    document.getElementById('infoDetails').innerHTML=`
      <li><strong>Type:</strong> ${d.type.name}</li>
      <li><strong>Power:</strong> ${d.power||'N/A'}</li>
      <li><strong>PP:</strong> ${d.pp}</li>
      <li><strong>Accuracy:</strong> ${d.accuracy||'N/A'}</li>
      <li><strong>Category:</strong> ${d.damage_class.name}</li>`;
  }

  function openCalculator(){
    let n=document.getElementById('pokemonName').textContent.toLowerCase();
    if(n) window.open(`https://calc.pokemonshowdown.com/?p1=${n}`,'_blank');
    else alert('No Pokémon selected.');
  }
  function openShowdown(){
    let n=document.getElementById('pokemonName').textContent.trim();
    if(n){
      alert(`To add ${n}, click “Add Pokémon” and search "${n}"`);
      window.open('https://play.pokemonshowdown.com/teambuilder','_blank');
    } else alert('No Pokémon selected.');
  }

  document.getElementById("accentPicker").addEventListener("input", (e) => {
  const color = e.target.value;
  document.documentElement.style.setProperty('--accent', color);
});
// Load saved accent color
const savedAccent = localStorage.getItem('accentColor');
if (savedAccent) {
  document.documentElement.style.setProperty('--accent', savedAccent);
  document.getElementById('accentPicker').value = savedAccent;
}

// Save new color on change
document.getElementById("accentPicker").addEventListener("input", (e) => {
  const color = e.target.value;
  document.documentElement.style.setProperty('--accent', color);
  localStorage.setItem('accentColor', color);
});

let cobblemonMode = false;
let cobblemonList = [];

function toggleCobblemon() {
  cobblemonMode = !cobblemonMode;
  document.getElementById('toggleCobblemon').textContent = `Cobblemon: ${cobblemonMode ? 'ON' : 'OFF'}`;
  updateCobblemonStatus(currentPokemonName); // Ensure currentPokemonName is defined
}

function updateCobblemonStatus(pokemonName) {
  const statusElement = document.getElementById('cobblemonStatus');
  if (cobblemonMode) {
    const isAvailable = cobblemonList.includes(pokemonName.toLowerCase());
    statusElement.textContent = isAvailable ? '✅ In Cobblemon' : '❌ Not in Cobblemon';
    statusElement.style.display = 'block';
  } else {
    statusElement.style.display = 'none';
  }
}

// Load Cobblemon list from the spreadsheet
async function loadCobblemonList() {
  try {
    const response = await fetch('https://docs.google.com/spreadsheets/d/16JrrEp919HVn8YE0AtmeAu6_tPkMkKqEmRzMlKW442A/gviz/tq?tqx=out:csv');
    const csvText = await response.text();
    const lines = csvText.split('\n');
    cobblemonList = lines.map(line => line.split(',')[0].trim().toLowerCase());
  } catch (error) {
    console.error('Error loading Cobblemon list:', error);
  }
}


// Call this function on page load
loadCobblemonList();



  // init
  document.addEventListener('DOMContentLoaded', async ()=>{
    await fetchAllNames();
    setupAutocomplete();
    toggleDarkMode(); // start dark
  });
</script>
</body>
</html>
